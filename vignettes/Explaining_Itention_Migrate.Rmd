---
title: "Explaining Intention to Migrate"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Explaining Intention to Migrate}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE, 
                      collapse = FALSE,
                      comment = "#>",
                      fig.align = "center")
knitr::opts_chunk$set(fig.width = 12, fig.height = 9)
set.seed(1)
extrafont::loadfonts(quiet=TRUE)
options(scipen = 999) # turn-off scientific notation like 1e+48
library(unhcRstyle)
library(tidyverse)
library(tidymodels)
library(patchwork)
library(embed)
library(haven)
library(readxl)

```





```{r getdata}

# mainDir <- getwd()
# ## If you save your analysis under vignette folder...
# mainDirroot <- substring(mainDir, 0 , nchar(mainDir) - 10)

set.seed(12345)

## pulling the last available dataset from NCA

# srcs <-
#   list(guatemala = "http://datasets.americasbarometer.org/database/files/Guatemala%20LAPOP%20AmericasBarometer%202019%20v1.0_W.dta",
#        honduras = "http://datasets.americasbarometer.org/database/files/Honduras%20LAPOP%20AmericasBarometer%202018%20v1.0_W.dta",
#        elsalvador = "http://datasets.americasbarometer.org/database/files/ElSalvador%20LAPOP%20AmericasBarometer%202018%20v1.0_W.dta")
# 
# data <- srcs %>% map(compose(as_factor, read_dta))



mainDir <- getwd()
## If you save your analysis under vignette folder...
mainDirroot <- substring(mainDir, 0 , nchar(mainDir) - 10)


lapop.2019.GTM <- read.csv(paste0(mainDirroot, "/data-raw/lapop.2019.GTM.csv"), stringsAsFactors = TRUE)
lapop.2018.SLV <- read.csv(paste0(mainDirroot, "/data-raw/lapop.2018.SLV.csv"), stringsAsFactors = TRUE)
lapop.2018.HND <- read.csv(paste0(mainDirroot, "/data-raw/lapop.2018.HND.csv"), stringsAsFactors = TRUE)

# lapop.2019.GTM <- data$guatemala
# lapop.2018.SLV <- data$elsalvador
# lapop.2018.HND <- data$honduras

common <- Reduce(intersect,list(names(lapop.2019.GTM),
                                 names(lapop.2018.SLV),
                                 names(lapop.2018.HND)))
data <- rbind(lapop.2019.GTM[,common],
               lapop.2018.SLV[,common],
               lapop.2018.HND[,common])


# data1 <- read.csv(paste0(mainDirroot, "/data/dataLAPOP.csv"))
# 
# data <- data1[ which(data1$year %in% c("2018", "2019")),  ]

## Put all no response options to NA
data <- data %>% mutate(across(where(is.factor), ~na_if(., "No sabe")), 
                        across(where(is.factor), ~na_if(., "No responde")),
                        across(where(is.factor), ~na_if(., "No Aplica")))




```


 

## Predicting Intention

```{r}
ridit <- function(x) {
  r <-
    forcats::fct_count(x) %>%
    dplyr::filter(!is.na(f)) %>%
    dplyr::mutate(
      prop = n/sum(n),
      csum = cumsum(prop),
      ridit = dplyr::lag(csum, default = 0) + prop/2) %>%
    { purrr::set_names(.$ridit, .$f) }
  
  r[x] %>% purrr::set_names(NULL)
}
```


```{r}
mdata <-
  data %>%
  transmute(country = pais, urban = ur == "Urbano", #strata = estratopri,
            age = as.numeric(as.character(q2)), sex = q1,
            edu =
              ed %>%
              fct_recode("0" = "Ninguno", "18" = "18+") %>%
              compose(as.numeric, as.character)(),
            marital_status = 
              case_when(q11n == "Soltero" ~ "Single",
                        q11n == "Casado" | q11n == "Unión Libre (acompañado)" ~ "Couple",
                        TRUE ~ "Other"),
            hhsize = fct_recode(q12c, "20" = "20+") %>% compose(as.numeric, as.character)(),
            share_children =
              ((fct_recode(q12bn, "0" = "Ninguno") %>% compose(as.numeric, as.character)())/hhsize) %>%
              modify_if(~replace_na(.>=1, TRUE), ~NA_real_),
            # ethnicity = etid,
            ocup = 
              case_when(ocup4a == "Trabajando" | ocup4a == "No está trabajando en este momento pero tiene trabajo" ~ "Employed",
                        ocup4a == "Está buscando trabajo activamente" ~ "Searching for work",
                        TRUE ~ "Outside the labor force") %>% 
              fct_relevel("Employed", after = Inf),
            ## perc_econ = soct2, 
            perc_safety = pese2,
            # perc_trust = it1 == "Algo confiable" | it1 == "Muy confiable",
            # perc_natural_disaster = drk1, perc_env_severity = env2b,
            experienced_crime = vic1ext == "Sí", # crime_neighborhood = vicbar7 == "Sí",
            unsafe_neighborhood = str_detect(aoj11, "inseguro"),
            # leave_neighborhood = vic43 == "Sí", # Honduras only!!!
            # trust_judiciary = aoj12 == "Mucho" | aoj12 == "Algo",
            # trust_political_system = b3 == "4" | b3 == "5" | b3 == "6" | b3 == "Mucho",
            # # trust_police = infrax %>% na_if("[No Leer] No hay Policía/ No llegaría nunca"),
            # trust_police = infrax == "Menos de 10 minutos" | infrax == "Entre 10 y hasta 30 minutos",
            # recv_remittances = q10a == "Sí", rec_assistance = wf1 == "Sí",
            remittances_or_assistnace = q10a == "Sí" | wf1 == "Sí",
            wealth_percentile = q10new,
            intention = q14 == "Sí",
            # usa_contact = q10cus == "Sí",
            usa_contact_freq = q16 == "Todos los días" | q16 == "Una o dos veces a la semana" | q16 == "Una o dos veces por mes",
            food_insecure = fs2 == "Sí",
            social_media_user = smedia1 == "Sí" | smedia7 == "Sí"
            )

mdata <- 
  mdata %>% 
  group_by(country) %>% 
  mutate(wealth_percentile = ridit(wealth_percentile)) %>% 
  ungroup()

per_country <-
  mdata %>%
  split(.$country) %>%
  map_dfr(~glm(intention~., data = select(., -country), family = "binomial") %>%
            tidy(exponentiate = TRUE, conf.int = TRUE),
          .id = "country")
```



```{r }
per_country %>% 
  filter(!(conf.low < 1 & conf.high > 1)) %>%
  filter(term != "strata") %>%
  filter(term != "(Intercept)") %>%
  ggplot(aes(estimate, term)) + 
  geom_pointrange(aes(xmin = conf.low, xmax = conf.high, 
                      color = ifelse(test = estimate >1, yes = "red",   no = "blue"))) + 
  geom_text(aes(label = scales::label_number(accuracy = .01)(estimate)), 
            vjust = -0.5) +
  geom_vline(xintercept =1, size = 0.7, colour = "red") +
  facet_wrap(vars(country))+
  labs(title = "What are the variable impacting intention to migrate?", 
             subtitle = "Blue positive odds,Red negative odds, Whiskers displays with 95% Confidence Interval ",
             y = "Factors ", x = "Adjusted odds ratios ",
             caption = "Latin American Public Opinion Project / Vanderbilt University") +
  unhcRstyle::unhcr_theme() +
  theme(axis.text = element_text(size = 2),
        plot.title = element_text(size = 15),
        plot.subtitle = element_text(size = 12),
                legend.position = "none",
                panel.grid.major.x = element_line(color = "#cbcbcb"), 
                panel.grid.major.y = element_blank()) 
```


