---
title: "Hot Spot analysis"
output:
  rmarkdown::html_vignette:
    toc: yes
    fig_width: 8
    fig_height: 6
vignette: >
  %\VignetteIndexEntry{Hot Spot analysis}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      message = FALSE, 
                      warning = FALSE, 
                      collapse = FALSE,
                      comment = "#>",
                      fig.align = "center")
```

```{r}
library(AmericasBarometer)
library(plyr)
library(ggplot2)
library(stringr)
library(RColorBrewer)

library(tidyverse)
library(ggthemes)
library(ggrepel)
library(viridis)
library(RColorBrewer)
library(extrafont)
library(corrplot)
library(corrgram)
library(lsr)
library(reshape2)
library(OpenStreetMap)
library(sp)
library(ggmap)
library(rgdal)
library(scales)
library(knitr)
library(rmarkdown)
library(grid)
library(moments)

mainDir <- getwd()
## If you save your analysis under vignette folder...
mainDirroot <- substring(mainDir, 0 , nchar(mainDir) - 10)


lapop.trends <- read.csv(paste0(mainDirroot, "/data/dataLAPOP.csv"))

#table(lapop.trends$year, useNA= "ifany") 
## let's put 2019 & 2018 together

lapop.trends$year[lapop.trends$year=="2019"] <- "2018"
lapop.trends$year <- as.integer(lapop.trends$year)
lapop.trends$wave <- paste0(lapop.trends$ctrycollect, lapop.trends$year)

```


```{r} 
## getting correct district and gov from coordinates
geofile <- rgdal::readOGR(paste0(mainDirroot,"/data/america_adm1_surv.geojson"))
geofile$id <- geofile$pcodehcr


## Fortify
geofile.fort <- fortify(geofile, region = "id")
 
#geofile.map.fort <- dplyr::left_join( x = MainDataFrameMap, y = geofile.fort, by = "id")

# View(geofile@data)
# levels(as.factor(geofile@data$code_op))
# levels(as.factor(geofile@data$adm1_code))
# substr(geofile@data$adm1_code, 1,3) %in% c("SLV", "HND", "GTM")

## get extend
geofile2 <- geofile[ substr(geofile@data$adm1_code, 1,3) %in% c("SLV", "HND", "GTM"), ]
bbox <- geofile2 %>%  sf::st_bbox()


## Fortify
geofile.fort <- fortify(geofile2, region = "id")


# ## Map background
#  map <- get_map(c(left = as.numeric(bbox$xmin -  ((bbox$xmax - bbox$xmin)/10)), 
#                        bottom = as.numeric(bbox$ymin -  ((bbox$ymax - bbox$ymin)/10)), 
#                        right = as.numeric(bbox$xmax +  ((bbox$xmax - bbox$xmin)/10)), 
#                        top = as.numeric(bbox$ymax +   ((bbox$ymax - bbox$ymin)/10))), 
#                      maptype = "osm")


```

```{r}
plot1 <- ggplot( ) +
  geom_polygon(data = geofile.fort,
               aes(x = long, y = lat, # fill = monit.progres_groupsize, 
                   group = group
                   ),
               colour = "white", alpha = 0.7 ) +
  coord_equal() +
  theme_map() +
  scale_fill_viridis(
                      name = "Average value",
                      guide = guide_legend( direction = "horizontal", label.position = "bottom",
                                            keyheight = unit(2, units = "mm"),  keywidth = unit(length(labels)*10, units = "mm"),
                                            title.position = 'top',  title.hjust = 0.5, label.hjust = 1, nrow = 1, byrow = T, reverse = T )) +
  labs(title = "Tet Map: El Salvador, Hunduras & Guatemala" , 
       x = NULL, y = NULL,
       subtitle = "Displaying index value..",
       caption = "") +
   unhcRstyle::unhcr_theme() +
  
plot1
#ggpubr::ggarrange(unhcRstyle::left_align(plot1, c("caption", "subtitle", "title")), ncol = 1, nrow = 1)

```

